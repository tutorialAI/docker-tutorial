version: "3.1"

networks:
  mynetwork:
    ipam:
      config:
        - subnet: 172.30.0.0/24

services:

  nginx:
    image: nginx:1.17
    container_name: nginx
    ports:
        - "81:81"
        - "443:443"
    volumes:
        - ./nginx/conf/nginx.conf:/etc/nginx/nginx.conf
        - ./src:/src
        - ./nginx/logs:/var/log/nginx/
    depends_on:
      - php-fpm
    hostname: mysite.local
    networks:
      mynetwork:
        ipv4_address: 172.30.0.6

  php-fpm:
    build:
      context: .
      dockerfile: ./php-fpm/Dockerfile
    ports:
      - "9000:9000"
    volumes:
      - ./src:/src
      - ./php-fpm/conf/php.ini:/usr/local/etc/php/conf.d/php.ini
    depends_on:
      - mysql
    networks:
      mynetwork:
        ipv4_address: 172.30.0.7

  mysql:
    image: mysql:5.6
    # restart: always
    command: --innodb_use_native_aio=0
    environment:
      DB_HOST: 'php-fpm'
      MYSQL_ROOT_PASSWORD: 'admin'
      MYSQL_USER: 'root'
      MYSQL_PASSWORD: 'admin'
    ports:
      - "3307:3307"
    volumes:
      - ./data:/var/lib/mysql
      # - ./mysql/conf/my.cnf:/etc/mysql/my.cnf
      # - ./mysql/logs/general.log:/var/lib/mysql/general.log
    hostname: database  
    networks:
      mynetwork:
        ipv4_address: 172.30.0.8

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: phpmyadmin
    depends_on:
      - mysql
    environment:
      - PMA_ARBITRARY=1
    restart: always
    ports:
      - 8080:80
    volumes:
      - /sessions
    hostname: phpmyadmin.local  
    networks:
      mynetwork:
        ipv4_address: 172.30.0.9
